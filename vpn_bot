from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler, CallbackQueryHandler,
    MessageHandler, filters, ConversationHandler, ContextTypes
)

# ====== ØªÙ†Ø¸ÛŒÙ…Ø§Øª ======
ADMIN_ID = 694246194  # Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ù…Ø¯ÛŒØ±
BOT_TOKEN = "8162063193:AAH3ouuNYxoTKGN4zIncXEwfDIOPYpyd6iE"
CARD_NUMBER = "6037 9982 0796 4007"
CARD_OWNER = "Ø§Ø­Ù…Ø¯Ø±Ø¶Ø§ Ø§Ù„Ù‡â€ŒØ¯Ø§Ø¯ÛŒ"

# Ù…Ø±Ø§Ø­Ù„ Ú¯ÙØªÚ¯Ùˆ
LOCATION, SERVICE_TYPE, DURATION, TRAFFIC, WAIT_PAYMENT = range(5)

# ====== Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ ======
PRICES = {
    ("vmess", 1, "20"): 30000,
    ("vless", 1, "20"): 35000,
    ("vmess", 1, "50"): 60000,
    ("vless", 1, "50"): 65000,
    ("vmess", 1, "100"): 100000,
    ("vless", 1, "100"): 110000,
    ("vmess", 3, "50"): 120000,
    ("vless", 3, "50"): 130000,
    ("vmess", 3, "100"): 180000,
    ("vless", 3, "100"): 190000,
    ("vmess", 3, "200"): 250000,
    ("vless", 3, "200"): 270000,
}

# Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("ÙØ±Ø§Ù†Ø³Ù‡", callback_data="ÙØ±Ø§Ù†Ø³Ù‡")],
        [InlineKeyboardButton("Ø³ÙˆØ¦Ø¯", callback_data="Ø³ÙˆØ¦Ø¯")],
        [InlineKeyboardButton("Ø§ØªØ±ÛŒØ´", callback_data="Ø§ØªØ±ÛŒØ´")],
        [InlineKeyboardButton("Ù‡Ù„Ù†Ø¯", callback_data="Ù‡Ù„Ù†Ø¯")]
    ]
    await update.message.reply_text("ğŸŒ Ù„Ø·ÙØ§Ù‹ Ù„ÙˆÚ©ÛŒØ´Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=InlineKeyboardMarkup(keyboard))
    return LOCATION

# Ø§Ù†ØªØ®Ø§Ø¨ Ù„ÙˆÚ©ÛŒØ´Ù†
async def select_location(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    context.user_data['location'] = query.data

    keyboard = [
        [InlineKeyboardButton("VMESS", callback_data="vmess")],
        [InlineKeyboardButton("VLESS", callback_data="vless")]
    ]
    await query.edit_message_text("ğŸ’  Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=InlineKeyboardMarkup(keyboard))
    return SERVICE_TYPE

# Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³
async def select_service(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    context.user_data['service_type'] = query.data

    keyboard = [
        [InlineKeyboardButton("1 Ù…Ø§Ù‡Ù‡", callback_data="1")],
        [InlineKeyboardButton("3 Ù…Ø§Ù‡Ù‡", callback_data="3")]
    ]
    await query.edit_message_text("ğŸ•’ Ù„Ø·ÙØ§Ù‹ Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=InlineKeyboardMarkup(keyboard))
    return DURATION

# Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Øª Ø³Ø±ÙˆÛŒØ³
async def select_duration(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    duration = int(query.data)
    context.user_data['duration'] = duration

    options = ["20", "30", "50", "80", "100"] if duration == 1 else ["50", "100", "200"]
    keyboard = [[InlineKeyboardButton(f"{o} Ú¯ÛŒÚ¯", callback_data=o)] for o in options]
    await query.edit_message_text("ğŸ“¦ Ù„Ø·ÙØ§Ù‹ Ø­Ø¬Ù… Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=InlineKeyboardMarkup(keyboard))
    return TRAFFIC

# Ø§Ù†ØªØ®Ø§Ø¨ Ø­Ø¬Ù… Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù‡Ø²ÛŒÙ†Ù‡ + Ú©Ø§Ø±Øª
async def select_traffic(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    traffic = query.data
    duration = context.user_data['duration']
    service_type = context.user_data['service_type']

    context.user_data['traffic'] = traffic
    key = (service_type, duration, traffic)
    price = PRICES.get(key)

    if price is None:
        await query.edit_message_text("âŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø³Ø±ÙˆÛŒØ³ Ù‚ÛŒÙ…ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù…Ø¯ÛŒØ± ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.")
        return ConversationHandler.END

    context.user_data['price'] = price

    response = (
        f"ğŸ“‹ Ù…Ø´Ø®ØµØ§Øª Ø³ÙØ§Ø±Ø´:\n"
        f"ğŸŒ Ù„ÙˆÚ©ÛŒØ´Ù†: {context.user_data['location']}\n"
        f"ğŸ’  Ù†ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³: {service_type.upper()}\n"
        f"ğŸ•’ Ù…Ø¯Øª: {duration} Ù…Ø§Ù‡Ù‡\n"
        f"ğŸ“¦ Ø­Ø¬Ù…: {traffic} Ú¯ÛŒÚ¯\n"
        f"ğŸ’° Ù…Ø¨Ù„Øº: {price:,} ØªÙˆÙ…Ø§Ù†\n\n"
        f"ğŸ’³ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª:\n`{CARD_NUMBER}`\n"
        f"ğŸ‘¤ Ø¨Ù‡ Ù†Ø§Ù…: {CARD_OWNER}\n\n"
        f"Ù„Ø·ÙØ§Ù‹ Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ²ØŒ ÙÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ú©Ø³ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯."
    )

    await query.edit_message_text(response, parse_mode="Markdown")
    return WAIT_PAYMENT

# Ø¯Ø±ÛŒØ§ÙØª ÙÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª
async def receive_payment(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    if update.message.photo:
        photo = update.message.photo[-1]
        caption = (
            f"ğŸ§¾ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± @{user.username or 'Ø¨Ø¯ÙˆÙ†â€ŒÙ†Ø§Ù…'} ({user.id})\n"
            f"ğŸŒ {context.user_data.get('location')}\n"
            f"ğŸ’  {context.user_data.get('service_type')}\n"
            f"ğŸ•’ {context.user_data.get('duration')} Ù…Ø§Ù‡Ù‡\n"
            f"ğŸ“¦ {context.user_data.get('traffic')} Ú¯ÛŒÚ¯\n"
            f"ğŸ’° Ù…Ø¨Ù„Øº: {context.user_data.get('price'):,} ØªÙˆÙ…Ø§Ù†\n\n"
            f"âš ï¸ Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ù†ÙÛŒÚ¯ Ø±Ø§ Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù†Ù…Ø§ÛŒÛŒØ¯."
        )
        await context.bot.send_photo(chat_id=ADMIN_ID, photo=photo.file_id, caption=caption)
        await update.message.reply_text("âœ… ÙÛŒØ´ Ø´Ù…Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯. Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ù†ÙÛŒÚ¯ Ø§Ø² Ø·Ø±Ù Ù…Ø¯ÛŒØ± Ø¨Ø§Ø´ÛŒØ¯.")
    else:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ ÙÛŒØ´ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.")
    return ConversationHandler.END

# Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ù†ÙÛŒÚ¯ ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ†
async def send_config(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_ID:
        return

    if update.message.reply_to_message:
        caption = update.message.reply_to_message.caption
        user_id = None
        for token in caption.split():
            if token.startswith("(") and token.endswith(")"):
                try:
                    user_id = int(token.strip("()"))
                    break
                except ValueError:
                    continue

        if user_id:
            await context.bot.send_message(chat_id=user_id, text=f"ğŸ” Ú©Ø§Ù†ÙÛŒÚ¯ Ø´Ù…Ø§:\n\n{update.message.text}")
            await update.message.reply_text("âœ… Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")
        else:
            await update.message.reply_text("âŒ Ø¢ÛŒØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯.")
    else:
        await update.message.reply_text("â— Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù… ÙÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ú©Ø§Ù†ÙÛŒÚ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.")

# ØªÙ†Ø¸ÛŒÙ… Ù‚ÛŒÙ…Øª ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ±
async def set_price(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_ID:
        return await update.message.reply_text("â›” Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ù†ÛŒØ³ØªÛŒØ¯.")

    try:
        service_type = context.args[0].lower()  # vmess / vless
        duration = int(context.args[1])         # 1 ÛŒØ§ 3
        traffic = context.args[2]               # Ù…Ø«Ù„Ø§Ù‹ "100"
        price = int(context.args[3])            # Ù…Ø¨Ù„Øº

        PRICES[(service_type, duration, traffic)] = price
        await update.message.reply_text(f"âœ… Ù‚ÛŒÙ…Øª {service_type.upper()} {duration} Ù…Ø§Ù‡Ù‡ / {traffic} Ú¯ÛŒÚ¯ Ø¨Ù‡ {price:,} ØªÙˆÙ…Ø§Ù† ØªØºÛŒÛŒØ± ÛŒØ§ÙØª.")
    except:
        await update.message.reply_text("âŒ Ø¯Ø³ØªÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø±.\nÙØ±Ù…Øª ØµØ­ÛŒØ­:\n/setprice <vmess|vless> <Ù…Ø¯Øª> <Ø­Ø¬Ù…> <Ù‚ÛŒÙ…Øª>\nÙ…Ø«Ø§Ù„:\n/setprice vless 1 50 70000")

# Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø±Ø¨Ø§Øª
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    conv = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            LOCATION: [CallbackQueryHandler(select_location)],
            SERVICE_TYPE: [CallbackQueryHandler(select_service)],
            DURATION: [CallbackQueryHandler(select_duration)],
            TRAFFIC: [CallbackQueryHandler(select_traffic)],
            WAIT_PAYMENT: [MessageHandler(filters.PHOTO, receive_payment)],
        },
        fallbacks=[]
    )

    app.add_handler(conv)
    app.add_handler(CommandHandler("setprice", set_price))
    app.add_handler(MessageHandler(filters.TEXT & filters.REPLY, send_config))

    print("ğŸ¤– Ø±Ø¨Ø§Øª Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª...")
    app.run_polling()

if __name__ == "__main__":
    main()
